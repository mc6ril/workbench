---
Generated: 2026-01-11 20:22:23
Ticket Number: 47
---

## Title

Add database constraints for foreign keys, uniqueness and data validation

## Type

Task

## Priority

High

## Story Points

5

## Labels

- infrastructure
- database
- schema
- constraints
- migrations
- supabase
- postgres

## Git Branch

`feat/workbench-47-database-constraints`

## Description

Add database constraints (foreign keys, unique constraints, check constraints) to enforce data integrity and domain rules at the database level. These constraints ensure referential integrity, prevent duplicate data, and enforce business rules like position validation and single-level nesting for tickets.

## User Story

As a developer, I want database constraints to enforce data integrity and domain rules so that invalid data cannot be stored in the database, even if application code has bugs.

## Scope

This ticket covers the implementation of all constraints mentioned in the planning document section 3.2 for the "Constraints" sub-area:

- Foreign Keys (referential integrity)
- Unique Constraints (prevent duplicates)
- Check Constraints (data validation)

## Acceptance Criteria

1. **Foreign Key Constraints**
   - [ ] Foreign key `tickets.project_id` → `projects.id` (on delete cascade or restrict)
   - [ ] Foreign key `tickets.epic_id` → `epics.id` (on delete set null or restrict)
   - [ ] Foreign key `tickets.parent_id` → `tickets.id` (on delete cascade or restrict)
   - [ ] Foreign key `epics.project_id` → `projects.id` (on delete cascade or restrict)
   - [ ] Foreign key `boards.project_id` → `projects.id` (on delete cascade or restrict)
   - [ ] Foreign key `columns.board_id` → `boards.id` (on delete cascade or restrict)
   - [ ] Appropriate delete actions (cascade, restrict, set null) based on domain rules

2. **Unique Constraints**
   - [ ] Unique constraint on `columns(status, board_id)` to ensure one column per status per board
   - [ ] Unique constraint on ticket positions within status/column (if applicable, or handled by application)
   - [ ] Unique constraints documented and justified

3. **Check Constraints**
   - [ ] Check constraint: `position >= 0` on `tickets.position` and `columns.position`
   - [ ] Check constraint: `title IS NOT NULL AND length(title) > 0` on `tickets.title`
   - [ ] Check constraint: `name IS NOT NULL AND length(name) > 0` on `projects.name`, `epics.name`, `columns.name`
   - [ ] Check constraint: `status IS NOT NULL AND length(status) > 0` on `tickets.status` and `columns.status`
   - [ ] Check constraint for single-level nesting (parent's parent must be null) - may require trigger or application logic
   - [ ] All check constraints enforce domain rules

4. **Migration File**
   - [ ] Migration file created in `supabase/migrations/` with descriptive name (e.g., `YYYYMMDDHHMMSS_add_database_constraints.sql`)
   - [ ] Constraints added to existing tables
   - [ ] Migration is idempotent (uses `IF NOT EXISTS` where appropriate)
   - [ ] Migration includes comments explaining constraint purposes

5. **Constraint Documentation**
   - [ ] Delete actions (cascade, restrict, set null) documented and justified
   - [ ] Unique constraints documented with business reasoning
   - [ ] Check constraints documented with domain rule references

6. **Database Setup**
   - [ ] Migration can be applied to Supabase database
   - [ ] Constraints are created successfully
   - [ ] Constraints enforce rules correctly (tested manually or with tests)
   - [ ] Existing valid data is not affected

## Technical Considerations

- **Migration Files**: Use Supabase migration system in `supabase/migrations/`
- **Constraint Order**: Add constraints after tables exist (from separate ticket)
- **Foreign Key Actions**: Choose appropriate delete actions based on domain rules:
  - `CASCADE`: Delete child records when parent is deleted
  - `RESTRICT`: Prevent deletion if child records exist
  - `SET NULL`: Set foreign key to null when parent is deleted
- **Unique Constraints**: Use `CREATE UNIQUE INDEX` or `UNIQUE` constraint
- **Check Constraints**: Use `CHECK` constraint syntax
- **Single-Level Nesting**: May require trigger or application-level validation (check constraint may not be sufficient)
- **Constraint Names**: Use descriptive constraint names for easier debugging
- **Error Messages**: PostgreSQL error messages will reference constraint names
- **Performance**: Constraints have minimal performance impact, indexes may be needed (separate ticket)
- **Dependencies**: Constraints depend on tables existing (from separate ticket)

## Definition of Done

- [ ] All foreign key constraints added
- [ ] All unique constraints added
- [ ] All check constraints added
- [ ] Delete actions chosen and documented
- [ ] Migration file created and tested
- [ ] Migration can be applied successfully
- [ ] Constraints enforce rules correctly
- [ ] Constraint names are descriptive
- [ ] Migration is idempotent and well-documented
- [ ] Code review completed
- [ ] Constraints align with domain rules
