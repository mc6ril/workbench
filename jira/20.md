---
Generated: 2025-01-27 14:30:00
Ticket Number: 20
---

# Finalize Auth Implementation

- Type: Feature
- Priority: High
- Story Points: 5
- Labels: auth, email-verification, password-reset, supabase
- Git Branch: `feat/workbench-20-finalize-auth-implementation`

## Description

Complete the authentication implementation by adding email verification flow, password reset functionality, and proper error handling for unverified users. Currently, signup handles email verification at the repository level but lacks UI feedback, callback handling, and password recovery features.

## User Story

As a user, I want to verify my email after signup, reset my password if forgotten, and receive clear feedback about my authentication status so that I can securely access Workbench.

## Acceptance Criteria

- [ ] **Email Verification Flow**
  - [ ] Display success message on signup page when email verification is required (instead of redirecting)
  - [ ] Show instructions to check email and verify account
  - [ ] Handle email verification callback from Supabase (redirect URL with tokens)
  - [ ] Create `/auth/verify-email` route to process verification tokens
  - [ ] Auto-login user after successful email verification
  - [ ] Redirect verified users to `/myworkspace`
  - [ ] Handle expired or invalid verification tokens with appropriate error messages

- [ ] **Password Reset Flow**
  - [ ] Add "Forgot password?" link on signin page
  - [ ] Create password reset request page (`/auth/reset-password`)
  - [ ] Implement `resetPasswordForEmail` repository method and usecase
  - [ ] Send password reset email via Supabase
  - [ ] Display success message after password reset email is sent
  - [ ] Handle password reset callback from Supabase (redirect URL with tokens)
  - [ ] Create `/auth/update-password` route to process reset tokens
  - [ ] Allow user to set new password after clicking reset link
  - [ ] Auto-login user after successful password reset
  - [ ] Handle expired or invalid reset tokens with appropriate error messages

- [ ] **Unverified User Sign-In Handling**
  - [ ] Detect when user tries to sign in with unverified email
  - [ ] Display clear error message indicating email verification is required
  - [ ] Provide option to resend verification email (if Supabase supports it)
  - [ ] Prevent unverified users from accessing protected routes

- [ ] **Type Safety & Supabase Types**
  - [ ] Verify all Supabase auth types are correctly imported from `@supabase/supabase-js`
  - [ ] Ensure proper typing for `signUp`, `signInWithPassword`, `resetPasswordForEmail`, `verifyOtp`, `updateUser`
  - [ ] Type all auth repository methods with correct Supabase return types
  - [ ] Add domain types for password reset input/output if needed

- [ ] **UI/UX Improvements**
  - [ ] Add i18n translation keys for email verification messages
  - [ ] Add i18n translation keys for password reset flow
  - [ ] Ensure all auth pages follow accessibility guidelines (WCAG 2.1 AA)
  - [ ] Use SCSS variables for all styling (no hardcoded values)
  - [ ] Provide clear loading states during verification/reset operations

## Technical Considerations

- **Domain** (`core/domain/`):
  - Add `ResetPasswordInput` type and `ResetPasswordSchema` (email validation)
  - Add `UpdatePasswordInput` type and `UpdatePasswordSchema` (password, token validation)
  - Add `VerifyEmailInput` type and `VerifyEmailSchema` (token validation)
  - Add `ResendVerificationInput` type if Supabase supports resending verification emails
  - Extend `AuthResult` type if needed for password reset flow
  - Add domain error types for verification/reset failures

- **Ports** (`core/ports/`):
  - Add `resetPasswordForEmail(email: string): Promise<void>` to `AuthRepository`
  - Add `updatePassword(input: UpdatePasswordInput): Promise<AuthResult>` to `AuthRepository`
  - Add `verifyEmail(input: VerifyEmailInput): Promise<AuthResult>` to `AuthRepository`
  - Add `resendVerificationEmail(email: string): Promise<void>` to `AuthRepository` (if supported)

- **Usecases** (`core/usecases/auth/`):
  - Create `resetPasswordForEmail` usecase
  - Create `updatePassword` usecase
  - Create `verifyEmail` usecase
  - Create `resendVerificationEmail` usecase (if supported)
  - All usecases validate input with Zod schemas

- **Infrastructure** (`infrastructure/supabase/auth/`):
  - Implement `resetPasswordForEmail` using `client.auth.resetPasswordForEmail()`
  - Implement `updatePassword` using `client.auth.verifyOtp()` with type 'recovery' and `client.auth.updateUser()`
  - Implement `verifyEmail` using `client.auth.verifyOtp()` with type 'email'
  - Implement `resendVerificationEmail` if Supabase supports it (may require admin API)
  - Map Supabase errors to domain errors appropriately
  - Handle Supabase callback URL parameters (tokens, type, etc.)

- **Presentation** (`presentation/`):
  - Update `SignupPage` to show email verification message when `requiresEmailVerification: true`
  - Create `VerifyEmailPage` at `app/auth/verify-email/page.tsx` to handle verification callbacks
  - Create `ResetPasswordPage` at `app/auth/reset-password/page.tsx` for password reset requests
  - Create `UpdatePasswordPage` at `app/auth/update-password/page.tsx` for setting new password
  - Create React Query hooks: `useResetPassword`, `useUpdatePassword`, `useVerifyEmail`, `useResendVerification`
  - Update `SigninPage` to add "Forgot password?" link
  - Update signin error handling to detect unverified email errors
  - Add loading states and success/error messages for all flows

## Supabase Types Reference

Before implementation, verify the following Supabase auth methods and their types:

- `client.auth.signUp()` - Returns `{ data: { user, session }, error }`
- `client.auth.signInWithPassword()` - Returns `{ data: { user, session }, error }`
- `client.auth.resetPasswordForEmail(email, options?)` - Returns `{ data, error }`
- `client.auth.verifyOtp({ email, token, type })` - Returns `{ data: { user, session }, error }`
- `client.auth.updateUser({ password })` - Returns `{ data: { user }, error }`
- `client.auth.resend()` - May be available for resending verification emails

Check `node_modules/@supabase/supabase-js/dist/module/types.d.ts` for exact type definitions.

## Email Verification Flow

1. User signs up → Supabase sends verification email
2. Repository returns `{ session: null, requiresEmailVerification: true }`
3. UI shows message: "Please check your email to verify your account"
4. User clicks link in email → Redirected to `/auth/verify-email?token=...&type=email`
5. Page calls `verifyEmail` usecase with token
6. Supabase verifies token → Returns session
7. User is auto-logged in → Redirected to `/myworkspace`

## Password Reset Flow

1. User clicks "Forgot password?" on signin page
2. User enters email on `/auth/reset-password`
3. System calls `resetPasswordForEmail` usecase
4. Supabase sends password reset email
5. UI shows success message: "Check your email for password reset instructions"
6. User clicks link in email → Redirected to `/auth/update-password?token=...&type=recovery`
7. User enters new password
8. System calls `updatePassword` usecase (verifies token + updates password)
9. User is auto-logged in → Redirected to `/myworkspace`

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Email verification flow works end-to-end
- [ ] Password reset flow works end-to-end
- [ ] All Supabase types are correctly typed
- [ ] Unit tests for new usecases (`resetPasswordForEmail`, `updatePassword`, `verifyEmail`)
- [ ] Unit tests for repository methods
- [ ] i18n translation keys added for all user-facing messages
- [ ] All pages follow accessibility guidelines (WCAG 2.1 AA)
- [ ] SCSS variables used for all styling
- [ ] Error handling covers all edge cases (expired tokens, invalid tokens, network errors)
- [ ] Manual testing completed for all flows
- [ ] Code review completed
- [ ] No TypeScript errors
- [ ] No ESLint errors

## Related Components

- `src/core/domain/auth.schema.ts` - Add password reset and verification types
- `src/core/ports/authRepository.ts` - Add new repository methods
- `src/core/usecases/auth/` - Add new usecases
- `src/infrastructure/supabase/auth/AuthRepository.supabase.ts` - Implement new methods
- `src/presentation/hooks/auth/` - Add new React Query hooks
- `src/app/signup/page.tsx` - Update to show email verification message
- `src/app/signin/page.tsx` - Add "Forgot password?" link and unverified user error handling
- `src/app/auth/verify-email/page.tsx` - New page for email verification
- `src/app/auth/reset-password/page.tsx` - New page for password reset request
- `src/app/auth/update-password/page.tsx` - New page for setting new password
- `src/shared/i18n/messages/fr.json` - Add translation keys

## Dependencies

- Ticket 16 (Authentication Screens) - Base auth implementation must be complete
- Supabase Auth configuration must have email verification enabled
- Supabase redirect URLs must be configured in Supabase dashboard

## Notes

- Supabase sends verification/reset emails automatically when configured in Auth settings
- Redirect URLs must be whitelisted in Supabase dashboard (e.g., `http://localhost:3000/auth/verify-email`, `http://localhost:3000/auth/update-password`)
- Email templates can be customized in Supabase dashboard
- Consider rate limiting for password reset requests to prevent abuse
- Password reset tokens expire after a set time (configurable in Supabase)
