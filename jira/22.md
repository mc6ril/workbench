---
Generated: 2025-01-27 20:00:00
Ticket Number: 22
---

# Add Unit Tests for Core Domain, Ports, Usecases, and Infrastructure

- Type: Task
- Priority: High
- Story Points: 8
- Labels: testing, unit-tests, core, domain, usecases, infrastructure
- Git Branch: `feat/workbench-22-add-unit-tests-core`

## Description

Add comprehensive unit tests for core business logic layers (domain, ports, usecases) and infrastructure error handling to ensure code quality, prevent regressions, and maintain Clean Architecture compliance. Currently, only 2 usecase tests and 1 port mock test exist, leaving most business logic untested.

## User Story

As a developer, I want comprehensive unit tests for all core business logic so that I can confidently refactor and extend features without breaking existing functionality.

## Acceptance Criteria

- [ ] **Domain Tests**
  - [ ] Test `repositoryError.ts` error factory functions (createNotFoundError, createConstraintError, createDatabaseError)
  - [ ] Test error factory functions return correct error types with proper structure
  - [ ] Test error messages are correctly formatted

- [ ] **Port Tests**
  - [ ] Test AuthRepository mock factory (createAuthRepositoryMock) in `__mocks__/core/ports/authRepository.ts`
  - [ ] Test ProjectRepository mock factory (createProjectRepositoryMock) in `__mocks__/core/ports/projectRepository.ts`
  - [ ] Verify all mock factories implement their respective port contracts correctly

- [ ] **Usecase Tests - Auth (10 usecases)**
  - [ ] Test `signUpUser` - success, validation errors, repository errors
  - [ ] Test `signInUser` - success, invalid credentials, repository errors
  - [ ] Test `signOutUser` - success, repository errors
  - [ ] Test `getCurrentSession` - with session, without session, repository errors
  - [ ] Test `resetPasswordForEmail` - success, email not found, repository errors
  - [ ] Test `updatePassword` - success, invalid token, repository errors
  - [ ] Test `verifyEmail` - success, invalid token, repository errors
  - [ ] Test `resendVerificationEmail` - success, repository errors
  - [ ] Test `updateUser` - success, validation errors, repository errors
  - [ ] Test `deleteUser` - success, repository errors

- [ ] **Usecase Tests - Project (3 missing usecases)**
  - [ ] Test `listProjects` - success, empty list, repository errors
  - [ ] Test `getProject` - success, not found, repository errors
  - [ ] Test `addUserToProject` - success, project not found, constraint violations, repository errors

- [ ] **Usecase Tests - Ticket (1 missing usecase)**
  - [ ] Test `listTickets` - success, empty list, repository errors

- [ ] **Infrastructure Tests**
  - [ ] Test `repositoryErrorMapper.ts` - maps Supabase errors to domain errors correctly
  - [ ] Test `errorHandlers.ts` - handleRepositoryError and handleAuthError map errors correctly
  - [ ] Test error handlers throw appropriate domain errors for different Supabase error types

- [ ] **Test Quality**
  - [ ] All tests follow Arrange-Act-Assert pattern
  - [ ] All tests use descriptive names explaining what is being tested
  - [ ] All tests cover success paths, error paths, and edge cases
  - [ ] All tests use proper TypeScript types (no `any`)
  - [ ] All tests use mocks from `__mocks__/` directory
  - [ ] All tests reset mocks in `beforeEach()` hooks

## Technical Considerations

- **Domain** (`core/domain/`):
  - Test `repositoryError.ts` error factory functions
  - Test error types and message formatting
  - No React/Next.js imports in domain tests

- **Ports** (`core/ports/`):
  - Create mock factories for AuthRepository and ProjectRepository (TicketRepository mock already exists)
  - Test mock factories implement port contracts correctly
  - Mock factories in `__mocks__/core/ports/`

- **Usecases** (`core/usecases/`):
  - Test all 14 usecases (10 auth, 3 project missing, 1 ticket missing)
  - Mock repositories using mock factories from `__mocks__/core/ports/`
  - Test input validation (Zod schema validation)
  - Test repository method calls with proper parameters
  - Test error propagation from repositories
  - No React/Next.js imports in usecase tests

- **Infrastructure** (`infrastructure/supabase/`):
  - Test error mappers and handlers (not repository implementations - tested via usecases)
  - Test Supabase error to domain error mapping
  - Test error handler functions

## Definition of Done

- [ ] All domain error factory functions have unit tests
- [ ] All port mock factories have tests verifying contract compliance
- [ ] All 14 usecases have comprehensive unit tests (success, error, edge cases)
- [ ] Infrastructure error mappers and handlers have unit tests
- [ ] All tests follow project testing patterns (Arrange-Act-Assert, descriptive names, TypeScript types)
- [ ] All tests use mocks from `__mocks__/` directory
- [ ] All tests pass (`yarn test`)
- [ ] Test coverage increases significantly for core layers
- [ ] No TypeScript errors
- [ ] No ESLint errors
- [ ] Code review completed

## Related Components

- `src/core/domain/repositoryError.ts` - Error factory functions to test
- `src/core/ports/authRepository.ts` - Port contract to create mock for
- `src/core/ports/projectRepository.ts` - Port contract to create mock for
- `src/core/usecases/auth/*.ts` - 10 auth usecases to test
- `src/core/usecases/project/listProjects.ts` - Missing test
- `src/core/usecases/project/getProject.ts` - Missing test
- `src/core/usecases/project/addUserToProject.ts` - Missing test
- `src/core/usecases/ticket/listTickets.ts` - Missing test
- `src/infrastructure/supabase/shared/errors/repositoryErrorMapper.ts` - Error mapper to test
- `src/infrastructure/supabase/shared/errors/errorHandlers.ts` - Error handlers to test
- `__mocks__/core/ports/ticketRepository.ts` - Reference for creating other port mocks
- `__tests__/core/usecases/createProject.test.ts` - Reference for usecase test structure
- `__tests__/core/usecases/hasProjectAccess.test.ts` - Reference for usecase test structure

## Dependencies

- None (standalone testing task)

## Notes

- Focus on testing business logic, not implementation details
- Infrastructure repositories are tested indirectly through usecases (not directly)
- Follow existing test patterns from `createProject.test.ts` and `hasProjectAccess.test.ts`
- Use `createProjectRepositoryMock` and `createTicketRepositoryMock` as references for creating `createAuthRepositoryMock`
- Ensure all tests are pure (no side effects, no external dependencies)
- Test error propagation from repositories to usecases
- Test Zod schema validation in usecases

