---
Generated: 2025-12-23 13:00:00
Ticket Number: 18
---

# Route Guards for Authentication & Project Access

- Type: Task
- Priority: High
- Story Points: 3
- Labels: auth, navigation, guards, middleware
- Git Branch: `feat/workbench-18-route-guards`

## Description

Implement route guards (middleware or layout-level checks) to protect routes and redirect users based on their authentication status and project access. This ensures unauthenticated users cannot access protected routes and users without project access are guided to the project overview page.

## User Story

As a system, I want to protect routes and redirect users appropriately so that only authenticated users with project access can use Workbench features.

## Acceptance Criteria

- [ ] **Authentication Guard**
  - [ ] Check if user is authenticated (via Supabase Auth session)
  - [ ] Redirect unauthenticated users to `/signin` page
  - [ ] Protect all routes except `/signup`, `/signin`, and public routes

- [ ] **Project Access Guard**
  - [ ] Check if authenticated user has access to any project
  - [ ] Redirect users without project access to project overview page (`/projects` or `/`)
  - [ ] Allow access to project overview, signin, and signup pages
  - [ ] Protect all application routes (home, backlog, board, etc.)

- [ ] **Implementation Approach**
  - [ ] Use Next.js middleware or layout-level guards
  - [ ] Leverage Supabase Auth session checking
  - [ ] Check project access via React Query hook or direct repository call
  - [ ] Avoid infinite redirect loops

- [ ] **Route Protection**
  - [ ] Public routes: `/signup`, `/signin`
  - [ ] Authenticated only: `/projects` (project overview)
  - [ ] Authenticated + Project access: All app routes (`/home`, `/backlog`, `/board`, etc.)

## Technical Considerations

- **Domain**: None (guards use infrastructure/auth)
- **Usecases**: Optional `hasProjectAccess` usecase if needed
- **Infrastructure**:
  - Supabase Auth: `supabaseClient.auth.getSession()` to check authentication
  - ProjectRepository: Check if user has projects via `list()` (RLS filters automatically)
- **Presentation**:
  - Next.js middleware: `middleware.ts` (root level)
  - Or layout guards: Check in root layout or protected route layouts
  - Auth hook: `useAuth()` or `useSession()` to check auth status
  - Project access hook: `useProjects()` to check if user has projects
- **Dependencies**: Supabase Auth, existing ProjectRepository

**Implementation Options:**

1. **Next.js Middleware** (recommended for route-level protection):
   - Create `middleware.ts` at root
   - Check auth session
   - Redirect based on route patterns

2. **Layout Guards** (alternative for component-level):
   - Check in root layout or protected layouts
   - Use React hooks (`useEffect`, React Query)
   - Redirect via Next.js router

**Note**: For this simple verification, either approach works. Middleware is more performant for route protection.

## Definition of Done

- [ ] Authentication guard redirects unauthenticated users to `/signin`
- [ ] Project access guard redirects users without projects to `/projects`
- [ ] Protected routes are inaccessible without authentication and project access
- [ ] No infinite redirect loops
- [ ] Public routes (`/signup`, `/signin`) are accessible without authentication
- [ ] Session checking works correctly
- [ ] TypeScript compilation succeeds
- [ ] No linting errors

## Related Components

- Files: `middleware.ts` (or `app/layout.tsx` for layout guards), `src/presentation/hooks/useAuth.ts` (optional)
- Dependencies: Supabase Auth, Next.js middleware or router
- Documentation: `docs/authentication-verification.md`, Next.js middleware docs

## Related Tickets

- Depends on: Ticket 16 (Authentication Screens), Ticket 17 (Project Overview)
- Blocks: All future feature development (home, backlog, board pages)
