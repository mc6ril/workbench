---
Generated: 2025-01-23
Ticket Number: 19
---

# Refactoring Existing Code

- Type: Task
- Priority: Medium
- Story Points: 5
- Labels: refactoring, code-quality, drv, performance, auth
- Git Branch: `feat/workbench-19-refactor-code`

## Description

Refactor existing code to improve quality, reduce duplication, optimize performance, and correctly handle all error cases and authentication. This refactoring covers repositories, error handling, authentication, and performance optimizations.

## User Story

As a developer, I want the code to be refactored so it is more maintainable, performant, and robust, in order to facilitate future evolutions and reduce bugs.

## Acceptance Criteria

- [ ] **File Location Verification**
  - [ ] Verify if repository files are in the correct locations according to Clean Architecture
  - [ ] Decide on a unique approach: use only factories or direct repositories, avoid duplication
  - [ ] Document the decision and chosen structure

- [ ] **Code Duplication Reduction (DRY)**
  - [ ] Extract duplicated code between `authRepositorySupabase.ts` and `authRepositorySupabaseFactory.ts` into shared utility functions
  - [ ] Extract duplicated code between `projectRepositorySupabase.ts` and `projectRepositorySupabaseFactory.ts`
  - [ ] Create a utility function for the repetitive error handling pattern in all repositories (try/catch with error code verification)
  - [ ] Standardize the use of `hasErrorCode` across all repositories (currently inconsistent: ticketRepository does inline verification, projectRepository uses `hasErrorCode`)

- [ ] **Error Handling Improvement**
  - [ ] Uniformize error handling across all repositories
  - [ ] Extract hardcoded auth error codes list (repeated 4 times in `authRepositorySupabase.ts`) into a shared constant
  - [ ] Verify that all error cases are properly handled (especially constraint errors, network errors, authentication errors)
  - [ ] Ensure errors are correctly mapped to domain errors

- [ ] **Performance Optimization**
  - [ ] Optimize `addCurrentUserAsMember` in project repositories to reduce multiple calls (currently: `getSession()` + `rpc('project_exists')` + `findById()` = 3 calls)
  - [ ] Check other methods that make multiple get() calls and optimize if necessary
  - [ ] Examine list() queries in repositories to ensure they are optimized

- [ ] **Email Verification Authentication Case Handling**
  - [ ] Modify `signUp` in authentication repositories to handle the case where `data.session` is `null` after a successful signup (case where Supabase sends a verification email)
  - [ ] Return an appropriate result indicating that the verification email has been sent instead of throwing an error
  - [ ] Adapt the `signUpUser` usecase to handle this new case
  - [ ] Update the signup UI to display an appropriate message when email verification is required
  - [ ] Add an `AuthResult` type with a `requiresEmailVerification` flag if necessary

## Technical Considerations

- **Domain**:
  - Possible addition of an extended `AuthResult` type to handle email verification case
  - Verify that domain errors are properly typed and consistent

- **Usecases**:
  - Adapt `signUpUser` to handle the new email verification case
  - Ensure all usecases correctly handle domain errors

- **Infrastructure**:
  - Create utility functions to reduce duplication in repositories
  - Create a `handleRepositoryError` helper to standardize error handling
  - Create shared constants for error codes
  - Optimize queries in repositories (especially `addCurrentUserAsMember`)
  - Decide on architecture: use only factories or unify both approaches

- **Presentation**:
  - Update `SignupPage` to handle the email verification required case
  - Adapt React Query hooks if necessary (e.g., `useSignUp`)

## Definition of Done

- [ ] All existing tests pass
- [ ] New tests added for email verification cases
- [ ] Tests for newly created utility functions
- [ ] Code review completed
- [ ] No major duplication in repositories
- [ ] All repositories use the same error handling approach
- [ ] Performance is optimized (reduction of multiple calls)
- [ ] Email verification case is correctly handled
- [ ] Documentation updated if necessary (repository architecture)

## Related Components

- `src/infrastructure/supabase/repositories/authRepositorySupabase.ts`
- `src/infrastructure/supabase/repositories/authRepositorySupabaseFactory.ts`
- `src/infrastructure/supabase/repositories/projectRepositorySupabase.ts`
- `src/infrastructure/supabase/repositories/projectRepositorySupabaseFactory.ts`
- `src/infrastructure/supabase/repositories/ticketRepositorySupabase.ts`
- `src/infrastructure/supabase/utils/errorMapper.ts`
- `src/shared/utils/guards.ts`
- `src/core/usecases/auth/signUpUser.ts`
- `src/presentation/hooks/useSignUp.ts`
- `src/app/signup/page.tsx`
- `src/core/domain/auth/auth.schema.ts`
